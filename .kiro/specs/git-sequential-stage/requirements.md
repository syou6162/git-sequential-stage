# 要件定義書

## 概要

git-sequential-stageは、Gitのパッチファイルから指定されたhunk（変更の塊）を順次ステージングエリアに追加するGo製のCLIツールです。このツールは、LLMエージェントが大きなGitの変更を意味的にまとまりのあるコミットに分割することを支援するために開発されました。

Gitにおいて、hunkとは`git diff`や`git add -p`で表示される変更の単位（@@で始まるヘッダーを持つ変更ブロック）を指します。このツールは、パッチID（`git patch-id`で計算される一意識別子）を使用してhunkの依存関係を正しく処理し、順次`git apply --cached`で適用することで「hunk番号のドリフト問題」を解決します。

## 要件

### 要件1: コマンドラインインターフェース

**ユーザーストーリー:** 開発者またはLLMエージェントとして、コマンドライン引数でどのhunkをステージするかを指定したい。これにより、ステージングプロセスをプログラム的に制御できる。

#### 受け入れ基準

1. ユーザーが`-patch`と`-hunk`フラグでコマンドを実行したとき、システムはパッチファイルのパスとhunk指定を受け入れること
2. ユーザーが複数の`-hunk`フラグを提供したとき、システムは指定されたすべてのhunk指定を処理すること
3. ユーザーが無効な引数を提供したとき、システムは使用方法の情報を表示してエラーコード1で終了すること
4. ユーザーが必須フラグを省略したとき、システムはエラーメッセージと使用方法の情報を表示すること

### 要件2: Hunk指定フォーマット

**ユーザーストーリー:** ユーザーとして、file:hunk_numbers形式でhunkを指定したい。これにより、どのファイルのどのhunkをステージするかを正確に制御できる。

#### 受け入れ基準

1. ユーザーが"file.go:1,3"形式でhunkを指定したとき、システムはfile.goのhunk 1と3をステージすること
2. ユーザーが複数のhunk指定を提供したとき、システムは指定されたすべてのファイルからhunkを処理すること
3. ユーザーが無効なhunk指定フォーマットを提供したとき、システムは検証エラーを返すこと
4. hunk番号が正の整数でないとき、システムは検証エラーを返すこと

### 要件3: Gitパッチファイル処理

**ユーザーストーリー:** ユーザーとして、システムにGitパッチファイル（`git diff`の出力形式）を解析して個別のhunk（@@ヘッダーで区切られた変更ブロック）を識別してほしい。これにより、特定のhunkを抽出してGitのステージングエリアに適用できる。

#### 受け入れ基準

1. パッチファイルが提供されたとき、システムはそれを解析してすべてのhunkをメタデータと共に識別すること
2. パッチファイルを解析するとき、システムは各hunkにグローバルインデックス、ファイルパス、ファイル内相対インデックスを割り当てること
3. 新規ファイルのhunk（@@-0,0形式）に遭遇したとき、システムはそれらを特別なケースとして処理すること
4. パッチファイルが読み取れないまたは解析できないとき、システムは適切なエラーを返すこと

### 要件4: パッチID計算

**ユーザーストーリー:** システムとして、hunkに対してユニークなパッチIDを計算したい。これにより、行番号が変更されてもhunkを確実に識別・追跡できる。

#### 受け入れ基準

1. hunkを処理するとき、システムはgit patch-id --stableを使用して安定したパッチIDを計算すること
2. hunkが新規ファイルのとき、システムはパッチID計算のためにファイル全体のdiffを抽出すること
3. hunkが通常の変更のとき、システムはgo-gitdiffライブラリを使用して特定のhunkコンテンツを抽出すること
4. パッチID計算が失敗したとき、システムはフォールバックIDを割り当てて処理を続行すること

### 要件5: 順次Gitステージング

**ユーザーストーリー:** ユーザーとして、hunkが正しい順序でGitのステージングエリアに適用されることを望む。これにより、依存関係のあるhunkが競合なく適切に`git apply --cached`でステージされる。

#### 受け入れ基準

1. 複数のhunkをステージングするとき、システムは指定された順序で一つずつ適用すること
2. 各hunkを適用するとき、システムは現在のdiffを取得してパッチIDでマッチするhunkを見つけること
3. hunkが正常に適用されたとき、システムはそれをターゲットリストから削除して続行すること
4. 現在のdiffでマッチするhunkが見つからないとき、システムは残りのパッチIDと共にエラーを返すこと

### 要件6: 依存関係検証

**ユーザーストーリー:** ユーザーとして、システムに必要な依存関係をチェックしてほしい。これにより、前提条件が不足している場合に明確なエラーメッセージを得られる。

#### 受け入れ基準

1. システムが開始するとき、gitコマンドの存在をチェックすること
2. gitが利用できないとき、システムは"git command not found"エラーを返すこと

### 要件7: エラーハンドリングと報告

**ユーザーストーリー:** ユーザーとして、操作が失敗したときに明確なエラーメッセージがほしい。これにより、問題を理解して解決できる。

#### 受け入れ基準

1. git applyが失敗したとき、システムはデバッグのために失敗したパッチを/tmpに保存し、詳細なエラーを返すこと
2. 引数検証が失敗したとき、システムは具体的な検証エラーメッセージを返すこと
3. ファイル操作が失敗したとき、システムは適切なファイルシステムエラーメッセージを返すこと
4. システムが正常に完了したとき、"Successfully staged specified hunks"を表示すること

### 要件8: ファイルフィルタリング

**ユーザーストーリー:** システムとして、ターゲットhunkを含むファイルのみを処理したい。これにより、パフォーマンスを最適化し、不要な処理を避けられる。

#### 受け入れ基準

1. 現在のdiffを取得するとき、システムはgit diff HEAD -- file1 file2を使用してターゲットファイルのみにdiffを制限すること
2. hunkを抽出するとき、システムはgo-gitdiffライブラリでファイルごとのhunkを識別すること
3. 複数のファイルを処理するとき、システムはhunk指定からユニークなファイルパスを収集すること
4. ターゲットファイルが指定されていないとき、システムは適切なエラーを返すこと

### 要件9: 一時ファイル管理

**ユーザーストーリー:** システムとして、一時ファイルを適切に管理したい。これにより、アーティファクトを残さず、現在のdiffを効率的に処理できる。

#### 受け入れ基準

1. 現在のdiffを処理するとき、システムはhunk処理のために一時ファイルを作成すること
2. 一時ファイルが作成されたとき、システムは使用後にそれらがクリーンアップされることを保証すること
3. 一時ファイルの作成が失敗したとき、システムは適切なエラーを返すこと
4. 一時ファイルへの書き込みが失敗したとき、システムは適切なエラーを返すこと

### 要件10: コマンド実行の抽象化

**ユーザーストーリー:** 開発者として、コマンド実行を抽象化したい。これにより、システムをモックエグゼキューターでテストできる。

#### 受け入れ基準

1. 外部コマンドを実行するとき、システムはCommandExecutorインターフェースを使用すること
2. コマンドが標準入力を必要とするとき、システムはExecuteWithStdinメソッドをサポートすること
3. システムを作成するとき、CommandExecutor実装を受け入れること
4. テスト時に、システムはモックCommandExecutor実装で動作すること