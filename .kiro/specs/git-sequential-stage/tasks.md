# 実装計画

- [x] 1. コードベースの現状分析と文書化
  - 既存のコード構造を分析し、改善点を特定する
  - 未使用関数や重複コードを識別する
  - テストカバレッジの現状を確認する
  - _要件: 要件10_

- [ ] 2. パッチ解析ライブラリへの移行（メインリファクタリング）
  - [ ] 2.1 go-gitdiffパッケージの導入
    - bluekeyes/go-gitdiffパッケージを依存関係に追加する
    - 既存の文字列ベースパッチ解析との比較テストを作成する
    - _要件: 要件3_

  - [ ] 2.2 パッチ解析ロジックの置き換え
    - parsePatchFile関数をgo-gitdiffベースの実装に置き換える
    - 文字列マッチング（strings.HasPrefix等）をライブラリのAPIに置き換える
    - rename、削除、バイナリファイルの対応を追加する
    - _要件: 要件3_

  - [ ] 2.3 HunkInfo構造体の再設計
    - go-gitdiffの型に合わせてHunkInfo構造体を更新する
    - ファイル操作タイプ（追加/変更/削除/リネーム）の情報を追加する
    - バイナリファイル判定フラグを追加する
    - _要件: 要件3_

  - [ ] 2.4 新しいファイルタイプ対応の実装
    - リネームされたファイルのhunk処理を実装する
    - 削除されたファイルのhunk処理を実装する
    - バイナリファイルの適切な処理（スキップまたはエラー）を実装する
    - _要件: 要件3, 要件7_

- [ ] 3. 基本的なリファクタリング
  - [ ] 3.1 未使用コードの削除
    - 旧パッチ解析関数（文字列ベース）を削除する
    - 未使用関数（extractHunkContent等）を特定して削除する
    - 使われていない変数や定数を削除する
    - _要件: 要件3_

  - [ ] 3.2 関数の責任分離とサイズ削減
    - StageHunks関数を小さな責任単位に分割する
    - 複雑な条件分岐を別関数に抽出する
    - 単一責任原則に従って関数を再構成する
    - _要件: 要件5_

  - [ ] 3.3 重複コードの統合
    - 類似した処理を共通関数に抽出する
    - DRY原則を適用してコードの重複を削除する
    - _要件: 要件4, 要件5_

- [ ] 4. エラーハンドリングの改善
  - [ ] 4.1 統一されたエラー型の実装
    - カスタムエラー型を定義してエラー分類を明確化する
    - エラーコンテキスト情報を含むエラー構造体を作成する
    - _要件: 要件7_

  - [ ] 4.2 バイナリファイル・特殊ケースのエラー処理
    - バイナリファイル検出時の適切なエラーメッセージを実装する
    - リネーム・削除ファイルの処理エラーハンドリングを追加する
    - _要件: 要件7_

- [ ] 5. 最小限のテスト改善
  - [ ] 5.1 メインパッケージのテストカバレッジ向上
    - CLI引数処理のテストを追加する（現在22.2%）
    - エラーケースのテストを追加する
    - _要件: 要件1, 要件7_

  - [ ] 5.2 go-gitdiff移行後のテスト更新
    - 新しいパッチ解析ロジックのテストを作成する
    - リネーム・削除・バイナリファイルのテストケースを追加する
    - _要件: 要件3_

- [ ] 6. ドキュメント更新
  - [ ] 6.1 コードコメントの改善
    - 公開関数にGoDocコメントを追加する
    - 複雑なロジックに説明コメントを追加する
    - _要件: 要件10_

  - [ ] 6.2 README更新
    - go-gitdiff移行後の新機能（リネーム・削除対応）をREADMEに追記する
    - 使用例を更新する
    - _要件: 要件3_